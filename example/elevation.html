<div>
    <input type="range" min="0.001" max="30" value="10" class="slider" id="sigma" style="width: 400px" />
</div>
<div id="map" style="height: 500px; width: 800px"></div>

<script src="../dist/gridviz-smoothing.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gridviz@3.0.31"></script>
<script src="https://cdn.jsdelivr.net/npm/gridviz-parquet@1.1.1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-array@3.2.4"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
<script>

    const seaColor = "#a4c8e1"
    const seaColorT = seaColor + "bb"
    const colorRamp = (t) => d3.interpolateRdYlGn(0.95 - t * 0.9)

    const map = new gridviz.Map(document.getElementById('map'), {
        x: 4200000, y: 2800000, z: 1000,
        backgroundColor: seaColor
    })
        .setZoomExtent([10, 5000])
        .addZoomButtons()
        .setViewFromURL()

    const dataset = new gridviz.MultiResolutionDataset(
        [100, 200, 500, 1000, 2000, 5000, 10000, 20000],
        resolution => new gviz_par.TiledParquetGrid(map,
            "https://raw.githubusercontent.com/jgaffuri/tiled-euroDEM/main/pub/v1/tiles_" + resolution + "/"),
        { preprocess: (c) => c.v != undefined && c.v != 0 }
    )

    //define style
    const style =
        new gridviz_smoothing.KernelSmoothingStyle({
            value: (cell) => +cell.v,
            sigma: (resolution) => (resolution * 10) / 10,
            factor: 1,
            filterSmoothed: (value) => value > 0.0005,
            styles:
                [
                    new gridviz.ShapeColorSizeStyle({
                        color: (cell, resolution, z, max) => d3.interpolateSpectral(1 - cell.ksmval / max),
                        viewScale: (cells) => d3.max(cells, cell => cell.ksmval)
                    }),
                    /*new gridviz.TextStyle({
                        text: (cell) => Math.floor(1000 * cell.ksmval) / 1000,
                        color: () => 'black',
                        fontSize: (cell, r) => r * 0.3,
                    }),*/
                ],
        })


    //add layer to map
    map.layers = [new gridviz.GridLayer(dataset, [style])]

    //sigma selection
    document.getElementById('sigma').oninput = function () {
        //set sigma
        map.layers[0].styles[0].sigma = (r, zf) => (r * +this.value) / 10
        //redraw
        map.redraw()
    }

</script>